---
- name: allow root login from the USB serial port
  lineinfile:
    dest: /etc/securetty
    line: ttyACM0
- name: enable a getty on the USB serial port
  lineinfile:
    dest: /etc/inittab
    line: "ttyACM0::respawn:/sbin/getty -L ttyACM0 115200 vt100"

- name: /etc/apk/repositories
  copy:
    dest: /etc/apk/repositories
    src: apk_repositories
- name: apk cache
  file:
    path: /etc/apk/cache
    state: link
    src: /media/sda1/cache
- apk: # TODO: manage and sync /etc/apk/world instead
    update_cache: yes
    name:
      - e2fsprogs
      - joe
      - openntpd
      - openssh
      - gptfdisk
      - python
      - strace
      - tmux
      - htop
      - wget
      - ca-certificates
      - rsync
      - tcpdump
      - sudo
      - zfs
      - zfs-udev
      - eudev
      - ntfs-3g
      - tree
      - pv
      - smartmontools
      - ncdu

- name: enable udev for /dev/disk/by-uuid
  service:
    name: "{{ item }}"
    enabled: yes
    state: started
    runlevel: sysinit
  with_items:
    - udev
    - udev-trigger

- name: /etc/local.d/tler.start
  copy:
    dest: /etc/local.d/tler.start
    src: tler.start
    mode: 0755

- name: load zfs module
  lineinfile:
    dest: /etc/modules
    line: zfs
  notify: modprobe zfs
- name: /etc/fstab
  copy:
    dest: /etc/fstab
    content: ""
- name: enable zfs-mount
  service:
    name: "{{ item }}"
    enabled: yes
    # state: started # zfs-import is not idempotent
  with_items:
    - zfs-mount
    - zfs-import
- name: DO_OVERLAY_MOUNTS=yes
  lineinfile:
    dest: /etc/conf.d/zfs
    regexp: '^#?\s*DO_OVERLAY_MOUNTS'
    line: "DO_OVERLAY_MOUNTS='yes'"

- name: zfs datasets owned by filippo
  file:
    state: directory
    path: "{{ item }}"
    owner: filippo
    group: filippo
  with_items:
    - /tank/misc
    - /tank/misc/AspireOne

- name: LBU_MEDIA
  lineinfile:
    dest: /etc/lbu/lbu.conf
    regexp: '^#?\s*LBU_MEDIA'
    line: "LBU_MEDIA=sda1"
- name: BACKUP_LIMIT
  lineinfile:
    dest: /etc/lbu/lbu.conf
    regexp: '^#?\s*BACKUP_LIMIT'
    line: "BACKUP_LIMIT=1024"

- name: /etc/local.d/cache.stop
  copy:
    dest: /etc/local.d/cache.stop
    src: cache.stop
    mode: 0755

- name: /etc/ssh/authorized_keys
  file:
    path: /etc/ssh/authorized_keys
    state: directory
    mode: 0755
- name: /etc/ssh/authorized_keys/filippo
  authorized_key:
    user: filippo
    key: "{{ ssh_key }}"
    path: /etc/ssh/authorized_keys/filippo
    manage_dir: false
- name: AuthorizedKeysFile
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: '^#?\s*AuthorizedKeysFile'
    line: "AuthorizedKeysFile /etc/ssh/authorized_keys/%u"

- name: /etc/passwd
  replace:
    dest: /etc/passwd
    regexp: '^filippo:x:([^:\n]*):([^:\n]*):[^:\n]*:[^:\n]*:[^:\n]*$'
    replace: 'filippo:x:\1:\2:Filippo Valsorda:/var/empty:/bin/ash'

- name: /etc/motd
  copy:
    dest: /etc/motd
    src: motd
- name: /etc/profile.d/motd.sh
  copy:
    dest: /etc/profile.d/motd.sh
    src: motd.sh
- name: color prompt
  command: mv /etc/profile.d/color_prompt /etc/profile.d/color_prompt.sh
  args:
    creates: /etc/profile.d/color_prompt.sh

- name: zpool get
  command: zpool get size,autoexpand,ashift
  changed_when: false
  register: zpool_get_result
- local_action:
    module: copy
    content: "{{ zpool_get_result.stdout }}"
    dest: "{{ inventory_hostname }}/zpool_get.txt"
  become: false
- name: zpool status
  command: zpool status
  changed_when: false
  register: zpool_status_result
- local_action:
    module: copy
    content: "{{ zpool_status_result.stdout }}"
    dest: "{{ inventory_hostname }}/zpool_status.txt"
  become: false
- name: zfs list
  command: zfs list -o name,mountpoint,canmount,compression,atime
  changed_when: false
  register: zfs_list_result
- local_action:
    module: copy
    content: "{{ zfs_list_result.stdout }}"
    dest: "{{ inventory_hostname }}/zfs_list.txt"
  become: false
- name: gdisk sda
  command: gdisk -l /dev/sda
  changed_when: false
  register: gdisk_sda_result
- local_action:
    module: copy
    content: "{{ gdisk_sda_result.stdout }}"
    dest: "{{ inventory_hostname }}/gdisk_sda.txt"
  become: false
